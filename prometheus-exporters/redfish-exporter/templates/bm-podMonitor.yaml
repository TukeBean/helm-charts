## https://doc.crds.dev/github.com/prometheus-operator/kube-prometheus/monitoring.coreos.com/PodMonitor/v1@v0.5.0
{{- $values := .Values.redfish }}
{{- if $values.podMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: {{ include "fullName" . }}
{{- if $values.namespace }}
  namespace: {{ $values.namespace }}
{{- end }}
  labels:
    app: {{ include "fullName" . }}
    type: exporter

spec:
  selector:
    matchLabels:
      app: {{ include "fullName" . }}
      type: exporter
  namespaceSelector:
    matchNames: {{ $values.namespace }}

  jobLabel: 'redfish/bm'
  podMetricsEndpoints:
    - interval: {{ $values.podMonitor.interval }}
      scrapeTimeout: {{ .Values.prometheus.operator.serviceMonitor.scrapeTimeout }}
      params:
        job: [redfish/cp]
      ## This is not working yet because it is not implemented
      ## see https://github.com/prometheus-operator/prometheus-operator/issues/2787
      file_sd_configs:
          - files :
            - /etc/prometheus/configmaps/atlas-netbox-sd/netbox.json
      path: /redfish
      port: {{ $values.listen_port }}
      scheme: http
      relabelings:
        - sourceLabels: [job]
          regex: redfish/bm
          action: keep
        - sourceLabels: [__address__]
          targetLabel: __param_target
        - sourceLabels: [__param_target]
          targetLabel: instance
        - targetLabel: __address__
          replacement: redfish-exporter:{{ $values.listen_port }}
{{- end }}
